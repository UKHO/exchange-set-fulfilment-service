# Recreating IaC

The Bicep files used for deployment were initially created by running `azd infra gen`. They were then manually edited.

If we need to regenerate from scratch again then you can run the `azd regenerate.cmd` script in the AppHost project. Afterwards the following updates need to be done:

1. `efs-cae.module.bicep` Undo all changes. This is an existing resource but currently the ```PublishAsExisting``` method isn't respected.
2. `efs-orchestrator.module.bicep`
   1. Change ```cpu: orchestratorCpu``` to ```cpu: json(orchestratorCpu)```.
   2. Remove the ```efs_cae_outputs_azure_container_registry_managed_identity_id``` reference from idntity/useridentities collection as both identities will now be the same and duplicates aren't allowed.
3. `adds-mocks-efs.module.bicep`
   1. Change ```cpu: addsMocksCpu``` to ```cpu: json(addsMocksCpu)```.
4. `efs-orchestrator-roles-efs-appconfig` Remove this folder and bicep file. It is generated in error.
5. `efs-orchestrator-roles-efs-events-namespace` Remove this folder and bicep file. It is generated in error.
6. `efs-orchestrator-roles-efs-storage` Remove this folder and bicep file. It is generated in error.
7. `main.bicep`
   1. Undo the change to the ```param environmentName``` description because it refers to the wrong resource group name.
   2. Rename the resource group to ```efs-${environmentName}-rg```.
   3. In ```module efs_cae``` set the scope to ```resourceGroup(efsRetainResourceGroup)```, remove the ```userPrincipalId``` parameter and add a new parameter ```efsContainerAppsEnvironmentName: efsContainerAppsEnvironmentName```.
   4. Remove ```module efs_orchestrator_roles_efs_appconfig```.
   5. Remove ```module efs_orchestrator_roles_efs_events_namespace```.
   6. Remove ```module efs_orchestrator_roles_efs_storage```.
   7. Set the output variables ```AZURE_CONTAINER_REGISTRY_ENDPOINT``` and ```EFS_CAE_AZURE_CONTAINER_REGISTRY_ENDPOINT``` to ```efs_cae_acr.outputs.loginServer```.
   8. Set the output variable ```EFS_CAE_AZURE_CONTAINER_REGISTRY_MANAGED_IDENTITY_ID``` to ```efs_service_identity.outputs.id```.
   9. Add storage name output: ```output EFS_STORAGE_NAME string = efs_storage.outputs.name```
8. `efs-builder-s100` Restore the deleted bicep and bicepparam files for the builder. These were manually created and won't be generated by azd.
