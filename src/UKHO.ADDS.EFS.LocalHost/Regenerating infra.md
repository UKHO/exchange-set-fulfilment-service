# Recreating IaC

The Bicep files used for deployment were initially created by running `azd infra gen`. They were then manually edited.

If we need to regenerate from scratch again then you can run the `azd regenerate.cmd` script in the repo root. Afterwards the following updates need to be done:

1. `efs-cae.module.bicep`
    1. Ensure that the `$` symbols are not escaped for the `infrastructureSubnetId` value.
    2. Manually add Aspire resource and hidden title tags to the resources.
2. `adds-configuration.tmpl.bicepparam` Update to read environment variables directly:
    ```
    using './adds-configuration.module.bicep'

    param adds_configuration_containerimage = readEnvironmentVariable('CONTAINER_IMAGE')
    param adds_configuration_containerport = readEnvironmentVariable('CONTAINER_PORT')
    param adds_configuration_identity_outputs_clientid = readEnvironmentVariable('ADDS_CONFIGURATION_IDENTITY_CLIENTID')
    param adds_configuration_identity_outputs_id = readEnvironmentVariable('ADDS_CONFIGURATION_IDENTITY_ID')
    param adds_configuration_kv_outputs_vaulturi = readEnvironmentVariable('ADDS_CONFIGURATION_KV_VAULTURI')
    param adds_configuration_was_outputs_tableendpoint = readEnvironmentVariable('ADDS_CONFIGURATION_WAS_TABLEENDPOINT')
    param efs_cae_outputs_azure_container_apps_environment_default_domain = readEnvironmentVariable('EFS_CAE_AZURE_CONTAINER_APPS_ENVIRONMENT_DEFAULT_DOMAIN')
    param efs_cae_outputs_azure_container_apps_environment_id = readEnvironmentVariable('EFS_CAE_AZURE_CONTAINER_APPS_ENVIRONMENT_ID')
    param efs_cae_outputs_azure_container_registry_endpoint = readEnvironmentVariable('EFS_CAE_AZURE_CONTAINER_REGISTRY_ENDPOINT')
    param efs_cae_outputs_azure_container_registry_managed_identity_id = readEnvironmentVariable('EFS_CAE_AZURE_CONTAINER_REGISTRY_MANAGED_IDENTITY_ID')
    ```
3. `adds-mocks-efs.tmpl.bicepparam` Update to read environment variables directly:
    ```
    using './adds-mocks-efs.module.bicep'

    param adds_mocks_efs_containerimage = readEnvironmentVariable('CONTAINER_IMAGE')
    param adds_mocks_efs_containerport = readEnvironmentVariable('CONTAINER_PORT')
    param efs_cae_outputs_azure_container_apps_environment_default_domain = readEnvironmentVariable('EFS_CAE_AZURE_CONTAINER_APPS_ENVIRONMENT_DEFAULT_DOMAIN')
    param efs_cae_outputs_azure_container_apps_environment_id = readEnvironmentVariable('EFS_CAE_AZURE_CONTAINER_APPS_ENVIRONMENT_ID')
    param efs_cae_outputs_azure_container_registry_endpoint = readEnvironmentVariable('EFS_CAE_AZURE_CONTAINER_REGISTRY_ENDPOINT')
    param efs_cae_outputs_azure_container_registry_managed_identity_id = readEnvironmentVariable('EFS_CAE_AZURE_CONTAINER_REGISTRY_MANAGED_IDENTITY_ID')
    ```
4. `efs-orchestrator.tmpl.bicepparam` Update to read environment variables directly:
    ```
    using './efs-orchestrator.module.bicep'

    param efs_cae_outputs_azure_container_apps_environment_default_domain = readEnvironmentVariable('EFS_CAE_AZURE_CONTAINER_APPS_ENVIRONMENT_DEFAULT_DOMAIN')
    param efs_cae_outputs_azure_container_apps_environment_id = readEnvironmentVariable('EFS_CAE_AZURE_CONTAINER_APPS_ENVIRONMENT_ID')
    param efs_cae_outputs_azure_container_registry_endpoint = readEnvironmentVariable('EFS_CAE_AZURE_CONTAINER_REGISTRY_ENDPOINT')
    param efs_cae_outputs_azure_container_registry_managed_identity_id = readEnvironmentVariable('EFS_CAE_AZURE_CONTAINER_REGISTRY_MANAGED_IDENTITY_ID')
    param efs_orchestrator_containerimage = readEnvironmentVariable('CONTAINER_IMAGE')
    param efs_orchestrator_containerport = readEnvironmentVariable('CONTAINER_PORT')
    param efs_orchestrator_identity_outputs_clientid = readEnvironmentVariable('EFS_ORCHESTRATOR_IDENTITY_CLIENTID')
    param efs_orchestrator_identity_outputs_id = readEnvironmentVariable('EFS_ORCHESTRATOR_IDENTITY_ID')
    param efs_storage_outputs_blobendpoint = readEnvironmentVariable('EFS_STORAGE_BLOBENDPOINT')
    param efs_storage_outputs_queueendpoint = readEnvironmentVariable('EFS_STORAGE_QUEUEENDPOINT')
    param efs_storage_outputs_tableendpoint = readEnvironmentVariable('EFS_STORAGE_TABLEENDPOINT')
    ```
5. `main.bicep`
   1. Add storage name output: ```output EFS_STORAGE_NAME string = efs_storage.outputs.name```
   2. Rename the resource group to ```efs-${environmentName}-rg```.
6. `efs-builder-s100` Restore the deleted bicep and bicepparam files for the builder. These were manually created and won't be generated by azd. These files sit under ```exchange-set-fulfilment-service\infra\efs-builder-s100```.
