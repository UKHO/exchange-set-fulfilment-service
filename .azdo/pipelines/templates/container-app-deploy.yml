parameters:
# The name of the service connection for deployment.
- name: AzureSubscription
  type: string
# The name of the container app to deploy.
- name: AppName
  type: string
# If true, additional debugging will be enabled.
- name: AdditionalDebugging
  type: boolean
  default: false
# Skip deployment if false.
- name: DeployApp
  type: boolean
  default: true

steps:
- task: AzureCLI@2
  displayName: Deploy ${{ parameters.AppName }}
  condition: and(succeeded(), eq('${{ parameters.DeployApp }}', true))
  inputs:
    azureSubscription: ${{ parameters.AzureSubscription }}
    workingDirectory: $(Build.SourcesDirectory)/efs/src/UKHO.ADDS.EFS.LocalHost
    scriptType: bash
    scriptLocation: inlineScript
    ${{ if eq(parameters.AdditionalDebugging, true) }}:
      inlineScript: |
        set -e
        echo "Current azd variables:"
        echo "--------------------------------------------------------------------------------"
        azd env get-values
        echo "--------------------------------------------------------------------------------"
        echo "azure env variables"
        env
        echo "--------------------------------------------------------------------------------"
        azd deploy ${{ parameters.AppName }} --no-prompt --debug

       
    ${{ else }}:
      inlineScript: |
        azd deploy ${{ parameters.AppName }} --no-prompt
  env:
    AZURE_SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID)
    AZURE_ENV_NAME: $(AZURE_ENV_NAME)
    AZURE_LOCATION: $(AZURE_LOCATION)
    AZURE_SUBNET_RESOURCE_ID: $(AZURE_SUBNET_RESOURCE_ID)
    AZURE_ADDS_ENVIRONMENT: $(AZURE_ENV_NAME)
    EFS_APP_REG_CLIENTID: $(EFS_APP_REG_CLIENTID)
    EFS_APP_REG_TENANTID: $(EFS_APP_REG_TENANTID)
