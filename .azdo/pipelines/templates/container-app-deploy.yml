parameters:
# The name of the service connection for deployment.
- name: AzureSubscription
  type: string
# The name of the container app to deploy.
- name: AppName
  type: string
# If true, additional debugging will be enabled.
- name: AdditionalDebugging
  type: boolean
  default: false
# Skip deployment if false.
- name: DeployApp
  type: boolean
  default: true

steps:
- task: AzureCLI@2
  displayName: Deploy ${{ parameters.AppName }}
  condition: and(succeeded(), eq('${{ parameters.DeployApp }}', true))
  inputs:
    azureSubscription: ${{ parameters.AzureSubscription }}
    workingDirectory: $(Build.SourcesDirectory)/efs/src/UKHO.ADDS.EFS.LocalHost
    scriptType: bash
    scriptLocation: inlineScript
    ${{ if eq(parameters.AdditionalDebugging, true) }}:
      inlineScript: |
        set -e

        azd deploy ${{ parameters.AppName }} --no-prompt --debug

        echo "Current azd variables:"
        echo "--------------------------------------------------------------------------------"
        azd env get-values
        echo "--------------------------------------------------------------------------------"
       
    ${{ else }}:
      inlineScript: |
        azd deploy ${{ parameters.AppName }} --no-prompt
  env:
    AZURE_SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID)
    AZURE_ENV_NAME: $(AZURE_ENV_NAME)
    AZURE_LOCATION: $(AZURE_LOCATION)
    AZURE_SUBNET_RESOURCE_ID: $(AZURE_SUBNET_RESOURCE_ID)
    AZURE_ADDS_ENVIRONMENT: $(AZURE_ENV_NAME)
    AZURE_ORCHESTRATOR_CPU: $(AZURE_ORCHESTRATOR_CPU)
    AZURE_ORCHESTRATOR_MEMORY: $(AZURE_ORCHESTRATOR_MEMORY)
    AZURE_EFS_APP_REG_CLIENTID: $(AZURE_EFS_APP_REG_CLIENTID)
    AZURE_EFS_APP_REG_TENANTID: $(AZURE_EFS_APP_REG_TENANTID)
    AZURE_EFS_B2C_APP_CLIENTID: $(AZURE_EFS_B2C_APP_CLIENTID)
    AZURE_EFS_B2C_APP_DOMAIN : $(AZURE_EFS_B2C_APP_DOMAIN)
    AZURE_EFS_B2C_APP_INSTANCE : $(AZURE_EFS_B2C_APP_INSTANCE)
    AZURE_EFS_B2C_APP_SIGNIN_POLICY : $(AZURE_EFS_B2C_APP_SIGNIN_POLICY)
    AZURE_EFS_B2C_APP_TENANTID : $(AZURE_EFS_B2C_APP_TENANTID)
    AZURE_ELASTIC_APMAPI_KEY: $(AZURE_ELASTIC_APMAPI_KEY)
    AZURE_ELASTIC_APMSERVER_URL: $(AZURE_ELASTIC_APMSERVER_URL)
    AZURE_ELASTIC_APMENVIRONMENT: $(AZURE_ELASTIC_APMENVIRONMENT)
    AZURE_ELASTIC_APMSERVICE_NAME: $(AZURE_ELASTIC_APMSERVICE_NAME)
