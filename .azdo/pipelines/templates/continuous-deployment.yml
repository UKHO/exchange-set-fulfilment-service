parameters:
# The name of the environment to be used in Azure DevOps.
- name: AzureDevOpsEnvironment
  type: string
# Used to generate job names and, in lower case, to select the correct var/x-deploy.yml variable file.
- name: ShortName
  type: string
# Destroy resources, rather than deploying them.
- name: DestroyResources
  type: boolean
  default: false
# Deploy the orchestrator container app.
- name: DeployOrchestrator
  type: boolean
  default: false
# Deploy the S100 builder container app job.
- name: DeployBuilderS100
  type: boolean
  default: false
# Deploy the ADDS mock container app.
- name: DeployAddsMock
  type: boolean
  default: false
# Deploy the Redis container app.
- name: DeployRedis
  type: boolean
  default: false
# If true, additional debugging will be enabled.
- name: AdditionalDebugging
  type: boolean
  default: false
- name: RunFunctionalTests
  type: boolean
  default: false

jobs:
- deployment: ${{ parameters.ShortName }}DeployApp
  displayName: "${{ upper(parameters.ShortName) }} - app deploy"
  environment: ${{ parameters.AzureDevOpsEnvironment }}
  pool: $(LinuxPool)
  workspace:
    clean: all
  variables:
  - template: var/${{ lower(parameters.ShortName) }}-deploy.yml
  strategy:
    runOnce:
      deploy:
        steps:
        - checkout: self
          clean: true
          submodules: true
          path: s/efs

        - checkout: PrivateEfs
          condition: eq('${{ parameters.DeployBuilderS100 }}', true)
          clean: true
          path: s/pvtefs

        - script: |
            cp "$(Build.SourcesDirectory)/pvtefs/root3.tar.gz" "$(Build.SourcesDirectory)/efs/src/UKHO.ADDS.EFS.Builder.S100/root3.tar.gz"
            cp "$(Build.SourcesDirectory)/pvtefs/xchg-7.3.war" "$(Build.SourcesDirectory)/efs/src/UKHO.ADDS.EFS.Builder.S100/xchg-7.3.war"
          condition: eq('${{ parameters.DeployBuilderS100 }}', true)
          displayName: Copy S100 builder files

        - download: none
  
        - script: |
            curl -fsSL https://aka.ms/install-azd.sh | bash
            azd version
            azd config set auth.useAzCliAuth "true"
          displayName: Install azd

        - task: UseDotNet@2
          displayName: Use .NET SDK $(SdkVersion)
          inputs:
            packageType: sdk
            version: $(SdkVersion)

        - ${{ if eq(parameters.DestroyResources, true) }}:

          - task: AzureCLI@2
            displayName: Destroy infrastructure
            inputs:
              azureSubscription: ${{ variables.AzureSubscription }}
              workingDirectory: $(Build.SourcesDirectory)/efs/src/UKHO.ADDS.EFS.LocalHost
              scriptType: bash
              scriptLocation: inlineScript
              ${{ if eq(parameters.AdditionalDebugging, true) }}:
                inlineScript: |
                  azd down --no-prompt --force --purge --debug
              ${{ else }}:
                inlineScript: |
                  azd down --no-prompt --force --purge
            env:
              AZURE_SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID)
              AZURE_ENV_NAME: $(AZURE_ENV_NAME)
              AZURE_LOCATION: $(AZURE_LOCATION)
              AZURE_SUBNET_RESOURCE_ID: $(AZURE_SUBNET_RESOURCE_ID)

        - ${{ else }}:

          - task: DotNetCoreCLI@2
            displayName: NuGet restore for non test projects only
            inputs:
              command: restore
              projects: |
                **/*.csproj
                !**/*Tests.csproj
              feedsToUse: config
              noCache: true
              nugetConfigPath: '$(Build.SourcesDirectory)/efs/BuildNuget.config'

          - task: AzureCLI@2
            displayName: Package application
            inputs:
              azureSubscription: ${{ variables.AzureSubscription }}
              workingDirectory: $(Build.SourcesDirectory)/efs/src/UKHO.ADDS.EFS.LocalHost
              scriptType: bash
              scriptLocation: inlineScript
              ${{ if eq(parameters.AdditionalDebugging, true) }}:
                inlineScript: |
                  set -e
                  azd package --no-prompt --debug

                  echo "Current azd variables:"
                  echo "--------------------------------------------------------------------------------"
                  azd env get-values
                  echo "--------------------------------------------------------------------------------"
              ${{ else }}:
                inlineScript: |
                  azd package --no-prompt
            env:
              AZURE_SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID)
              AZURE_ENV_NAME: $(AZURE_ENV_NAME)
              AZURE_LOCATION: $(AZURE_LOCATION)
              AZURE_SUBNET_RESOURCE_ID: $(AZURE_SUBNET_RESOURCE_ID)

          - task: AzureCLI@2
            displayName: Deploy permanent infrastructure
            inputs:
              azureSubscription: ${{ variables.AzureSubscription }}
              workingDirectory: $(Build.SourcesDirectory)/efs
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -e
                echo "Deploying resources..."
                DEPLOYMENT_NAME=$AZURE_ENV_NAME-retain-$EPOCHSECONDS
                cd "$(Build.SourcesDirectory)/efs/infra-retain"

                if [ "${{ parameters.AdditionalDebugging }}" == "True" ]; then
                  az deployment sub create --name $DEPLOYMENT_NAME --location $AZURE_LOCATION --no-prompt --parameters environmentName=$AZURE_ENV_NAME location=$AZURE_LOCATION --template-file main.bicep --debug
                else
                  az deployment sub create --name $DEPLOYMENT_NAME --location $AZURE_LOCATION --no-prompt --parameters environmentName=$AZURE_ENV_NAME location=$AZURE_LOCATION --template-file main.bicep
                fi

                echo "Retrieving outputs..."
                EFS_SERVICE_IDENTITY_RESOURCE_GROUP=$(az deployment sub show --name $DEPLOYMENT_NAME --query properties.outputs.efS_SERVICE_IDENTITY_RESOURCE_GROUP.value --output tsv)
                EFS_SERVICE_IDENTITY_NAME=$(az deployment sub show --name $DEPLOYMENT_NAME --query properties.outputs.efS_SERVICE_IDENTITY_NAME.value --output tsv)

                echo "Storing variables..."
                echo "##vso[task.setvariable variable=AZURE_EFS_SERVICE_IDENTITY_RESOURCE_GROUP;]$EFS_SERVICE_IDENTITY_RESOURCE_GROUP"
                echo "##vso[task.setvariable variable=AZURE_EFS_SERVICE_IDENTITY_NAME;]$EFS_SERVICE_IDENTITY_NAME"

                if [ "${{ parameters.AdditionalDebugging }}" == "True" ]; then
                  echo "Job variables:"
                  echo "--------------------------------------------------------------------------------"
                  echo $EFS_SERVICE_IDENTITY_RESOURCE_GROUP
                  echo $EFS_SERVICE_IDENTITY_NAME
                  echo "--------------------------------------------------------------------------------"
                fi
            env:
              AZURE_SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID)
              AZURE_ENV_NAME: $(AZURE_ENV_NAME)
              AZURE_LOCATION: $(AZURE_LOCATION)

          - task: AzureCLI@2
            displayName: Provision infrastructure
            inputs:
              azureSubscription: ${{ variables.AzureSubscription }}
              workingDirectory: $(Build.SourcesDirectory)/efs/src/UKHO.ADDS.EFS.LocalHost
              scriptType: bash
              scriptLocation: inlineScript
              ${{ if eq(parameters.AdditionalDebugging, true) }}:
                inlineScript: |
                  set -e
                  azd provision --no-prompt --debug

                  echo "Current azd variables:"
                  echo "--------------------------------------------------------------------------------"
                  azd env get-values
                  echo "--------------------------------------------------------------------------------"
              ${{ else }}:
                inlineScript: |
                  azd provision --no-prompt
            env:
              AZURE_SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID)
              AZURE_ENV_NAME: $(AZURE_ENV_NAME)
              AZURE_LOCATION: $(AZURE_LOCATION)
              AZURE_SUBNET_RESOURCE_ID: $(AZURE_SUBNET_RESOURCE_ID)
              AZURE_ADDS_ENVIRONMENT: $(AZURE_ENV_NAME)
              AZURE_EFS_SERVICE_IDENTITY_RESOURCE_GROUP: $(AZURE_EFS_SERVICE_IDENTITY_RESOURCE_GROUP)
              AZURE_EFS_SERVICE_IDENTITY_NAME: $(AZURE_EFS_SERVICE_IDENTITY_NAME)

          - task: AzureCLI@2
            displayName: Run configuration seeder
            inputs:
              azureSubscription: ${{ variables.AzureSubscription }}
              workingDirectory: $(Build.SourcesDirectory)/efs/src/UKHO.ADDS.EFS.LocalHost
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -e
                echo "Reading azd variables..."
                while IFS='=' read -r key value; do
                    value=$(echo "$value" | sed 's/^"//' | sed 's/"$//')
                    export "$key=$value"
                done <<EOF
                $(azd env get-values)
                EOF

                if [ "${{ parameters.AdditionalDebugging }}" == "True" ]; then
                  echo "Current environment variables:"
                  echo "--------------------------------------------------------------------------------"
                  env | sort
                  echo "--------------------------------------------------------------------------------"
                fi

                sed -i "s/{{cae_domain}}/${AZURE_CONTAINER_APPS_ENVIRONMENT_DEFAULT_DOMAIN}/g" "$(Build.SourcesDirectory)/efs/configuration/external-services.json"

                if [ "${{ parameters.AdditionalDebugging }}" == "True" ]; then
                  echo "external-services.json:"
                  echo "--------------------------------------------------------------------------------"
                  cat "$(Build.SourcesDirectory)/efs/configuration/external-services.json"
                  echo "--------------------------------------------------------------------------------"
                fi

                dotnet run --project $(Build.SourcesDirectory)/efs/configuration/UKHO.ADDS.Aspire.Configuration.Seeder/UKHO.ADDS.Aspire.Configuration.Seeder.csproj --configuration Release --no-restore -- "efs" "$(AZURE_ENV_NAME)" "$(Build.SourcesDirectory)/efs/configuration/configuration.json" "$(Build.SourcesDirectory)/efs/configuration/external-services.json" "$EFS_APPCONFIG_APPCONFIGENDPOINT"
            env:
              AZURE_SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID)
              AZURE_ENV_NAME: $(AZURE_ENV_NAME)
              AZURE_LOCATION: $(AZURE_LOCATION)
              AZURE_SUBNET_RESOURCE_ID: $(AZURE_SUBNET_RESOURCE_ID)

          - template: container-app-deploy.yml
            parameters:
              AzureSubscription: ${{ variables.AzureSubscription }}
              AppName: efs-redis
              AdditionalDebugging: ${{ parameters.AdditionalDebugging }}
              DeployApp: ${{ parameters.DeployRedis }}

          - template: container-app-deploy.yml
            parameters:
              AzureSubscription: ${{ variables.AzureSubscription }}
              AppName: adds-mocks-efs
              AdditionalDebugging: ${{ parameters.AdditionalDebugging }}
              DeployApp: ${{ parameters.DeployAddsMock }}

          - template: container-app-deploy.yml
            parameters:
              AzureSubscription: ${{ variables.AzureSubscription }}
              AppName: efs-orchestrator
              AdditionalDebugging: ${{ parameters.AdditionalDebugging }}
              DeployApp: ${{ parameters.DeployOrchestrator }}

          - template: container-app-job-deploy.yml
            parameters:
              AzureSubscription: ${{ variables.AzureSubscription }}
              AppName: efs-builder-s100
              ProjectFolder: UKHO.ADDS.EFS.Builder.S100
              AdditionalDebugging: ${{ parameters.AdditionalDebugging }}
              DeployApp: ${{ parameters.DeployBuilderS100 }}

          - ${{ if eq(parameters.RunFunctionalTests, true) }}:
            - task: PowerShell@2
              displayName: 'List folders in efs/test'
              inputs:
                targetType: 'inline'
                script: |
                  Write-Host "Listing folders in $(Build.SourcesDirectory)/efs/test"
                  Get-ChildItem -Path "$(Build.SourcesDirectory)/efs/test" -Directory | ForEach-Object { Write-Host $_.FullName }

            - task: UseDotNet@2
              displayName: 'Use .NET SDK $(SdkVersion)'
              inputs:
                packageType: sdk
                version: $(SdkVersion)

            - task: DotNetCoreCLI@2
              displayName: 'Restore NuGet packages for EndToEnd Tests'
              inputs:
                command: restore
                projects: '**/*UKHO.ADDS.EFS.EndToEndTests.csproj'
                feedsToUse: config
                noCache: true
                nugetConfigPath: '$(Build.SourcesDirectory)/BuildNuget.config'
                workingDirectory: '$(Build.SourcesDirectory)/efs/test/UKHO.ADDS.EFS.EndToEndTests'

            - task: DotNetCoreCLI@2
              displayName: 'Run EndToEnd(Functional) Tests'
              inputs:
                command: test
                projects: '**/*UKHO.ADDS.EFS.EndToEndTests.csproj'
                arguments: '--configuration Release --no-restore --logger trx'
                workingDirectory: '$(Build.SourcesDirectory)/efs/test/UKHO.ADDS.EFS.EndToEndTests'

            - task: DotNetCoreCLI@2
              displayName: 'Restore NuGet packages for Functional Tests'
              condition: always()
              inputs:
                command: restore
                projects: '**/*UKHO.ADDS.EFS.FunctionalTests.csproj'
                feedsToUse: config
                noCache: true
                nugetConfigPath: '$(Build.SourcesDirectory)/BuildNuget.config'
                workingDirectory: '$(Build.SourcesDirectory)/efs/test/UKHO.ADDS.EFS.FunctionalTests'

            - task: DotNetCoreCLI@2
              displayName: 'Run Functional Tests'
              condition: always()
              inputs:
                command: test
                projects: '**/*UKHO.ADDS.EFS.FunctionalTests.csproj'
                arguments: '--configuration Release --no-restore --logger trx'
                workingDirectory: '$(Build.SourcesDirectory)/efs/test/UKHO.ADDS.EFS.FunctionalTests'

# - ${{ if eq(parameters.RunFunctionalTests, true) }}:
#   - job: ${{ parameters.ShortName }}FunctionalTests
#     dependsOn:
#       - ${{ parameters.ShortName }}DeployApp
#     #pool: $(WindowsPool)
#     pool: $(LinuxPool)
#     displayName: '${{ upper(parameters.ShortName) }} - functional tests'
#     variables:
#       - template: var/${{ lower(parameters.ShortName) }}-deploy.yml
#     workspace:
#       clean: all
#     steps:
#       - checkout: self
#         clean: true
#         submodules: true
#         path: s/efs

#       - task: PowerShell@2
#         displayName: 'List folders in efs/test'
#         inputs:
#           targetType: 'inline'
#           script: |
#             Write-Host "Listing folders in $(Build.SourcesDirectory)/test"
#             Get-ChildItem -Path "$(Build.SourcesDirectory)/test" -Directory | ForEach-Object { Write-Host $_.FullName }

#       - task: UseDotNet@2
#         displayName: 'Use .NET SDK $(SdkVersion)'
#         inputs:
#           packageType: sdk
#           version: $(SdkVersion)

#       - task: DotNetCoreCLI@2
#         displayName: 'Restore NuGet packages for EndToEnd Tests'
#         inputs:
#           command: restore
#           projects: '**/*UKHO.ADDS.EFS.EndToEndTests.csproj'
#           feedsToUse: config
#           noCache: true
#           nugetConfigPath: '$(Build.SourcesDirectory)/BuildNuget.config'
#           workingDirectory: '$(Build.SourcesDirectory)/test/UKHO.ADDS.EFS.EndToEndTests'

#       - task: DotNetCoreCLI@2
#         displayName: 'Run EndToEnd(Functional) Tests'
#         inputs:
#           command: test
#           projects: '**/*UKHO.ADDS.EFS.EndToEndTests.csproj'
#           arguments: '--configuration Release --no-restore --logger trx'
#           workingDirectory: '$(Build.SourcesDirectory)/test/UKHO.ADDS.EFS.EndToEndTests'

#       - task: DotNetCoreCLI@2
#         displayName: 'Restore NuGet packages for Functional Tests'
#         condition: always()
#         inputs:
#           command: restore
#           projects: '**/*UKHO.ADDS.EFS.FunctionalTests.csproj'
#           feedsToUse: config
#           noCache: true
#           nugetConfigPath: '$(Build.SourcesDirectory)/BuildNuget.config'
#           workingDirectory: '$(Build.SourcesDirectory)/test/UKHO.ADDS.EFS.FunctionalTests'

#       - task: DotNetCoreCLI@2
#         displayName: 'Run Functional Tests'
#         condition: always()
#         inputs:
#           command: test
#           projects: '**/*UKHO.ADDS.EFS.FunctionalTests.csproj'
#           arguments: '--configuration Release --no-restore --logger trx'
#           workingDirectory: '$(Build.SourcesDirectory)/test/UKHO.ADDS.EFS.FunctionalTests'
