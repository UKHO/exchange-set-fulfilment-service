parameters:
# The name of the service connection for deployment.
- name: AzureSubscription
  type: string

steps:
- task: AzureCLI@2
  displayName: Get retained infrastructure details
  inputs:
    azureSubscription: ${{ parameters.AzureSubscription }}
    workingDirectory: $(Build.SourcesDirectory)/efs
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      set -e
      echo "Getting managed identity name..."
      EFS_SERVICE_IDENTITY_NAME=$(az identity list --resource-group $EFS_RETAIN_RESOURCE_GROUP --query "[?starts_with(name, '$(EFS_SERVICE_IDENTITY_PARTIAL_NAME)')].name" --output tsv)

      echo "Storing variables..."
      echo "##vso[task.setvariable variable=AZURE_EFS_SERVICE_IDENTITY_RESOURCE_GROUP;]$EFS_RETAIN_RESOURCE_GROUP"
      echo "##vso[task.setvariable variable=AZURE_EFS_SERVICE_IDENTITY_NAME;]$EFS_SERVICE_IDENTITY_NAME"

      echo "Retained resources found:"
      echo "--------------------------------------------------------------------------------"
      echo $EFS_RETAIN_RESOURCE_GROUP
      echo $EFS_SERVICE_IDENTITY_NAME
      echo "--------------------------------------------------------------------------------"
