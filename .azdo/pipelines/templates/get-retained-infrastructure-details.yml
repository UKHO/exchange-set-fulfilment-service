parameters:
# The name of the service connection for deployment.
- name: AzureSubscription
  type: string

steps:
- task: AzureCLI@2
  displayName: Get retained infrastructure details
  inputs:
    azureSubscription: ${{ parameters.AzureSubscription }}
    workingDirectory: $(Build.SourcesDirectory)/efs
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      set -e
      echo "Getting managed identity name..."
      EFS_SERVICE_IDENTITY_NAME=$(az identity list --resource-group $EFS_RETAIN_RESOURCE_GROUP --query "[?starts_with(name, '$(EFS_SERVICE_IDENTITY_PARTIAL_NAME)')].name" --output tsv)

      echo "Getting log analytics workspace name..."
      EFS_LOG_ANALYTICS_WORKSPACE_NAME=$(az monitor log-analytics workspace list --resource-group $EFS_RETAIN_RESOURCE_GROUP --query "[?starts_with(name, '$(EFS_LOG_ANALYTICS_WORKSPACE_PARTIAL_NAME)')].name" --output tsv)

      echo "Getting container registry name..."
      EFS_CONTAINER_REGISTRY_NAME=$(az acr list --resource-group $EFS_RETAIN_RESOURCE_GROUP --query "[?starts_with(name, '$(EFS_CONTAINER_REGISTRY_PARTIAL_NAME)')].name" --output tsv)

      echo "Getting container apps environment name..."
      EFS_CONTAINER_APPS_ENVIRONMENT_NAME=$(az containerapp env list --resource-group $EFS_RETAIN_RESOURCE_GROUP --query "[?starts_with(name, '$(EFS_CONTAINER_APPS_ENVIRONMENT_PARTIAL_NAME)')].name" --output tsv)

      echo "Getting application insights name..."
      EFS_APPLICATION_INSIGHTS_NAME=$(az monitor app-insights component show --resource-group $EFS_RETAIN_RESOURCE_GROUP --query "[?starts_with(name, '$(EFS_APPLICATION_INSIGHTS_PARTIAL_NAME)')].name" --output tsv)

      echo "Getting event hub namespace name..."
      EFS_EVENT_HUB_NAMESPACE_NAME=$(az eventhubs namespace list --resource-group $EFS_RETAIN_RESOURCE_GROUP --query "[?starts_with(name, '$(EFS_EVENT_HUB_NAMESPACE_PARTIAL_NAME)')].name" --output tsv)

      echo "Storing variables..."
      echo "##vso[task.setvariable variable=AZURE_EFS_RETAIN_RESOURCE_GROUP;]$EFS_RETAIN_RESOURCE_GROUP"
      echo "##vso[task.setvariable variable=AZURE_EFS_SERVICE_IDENTITY_NAME;]$EFS_SERVICE_IDENTITY_NAME"
      echo "##vso[task.setvariable variable=AZURE_EFS_LOG_ANALYTICS_WORKSPACE_NAME;]$EFS_LOG_ANALYTICS_WORKSPACE_NAME"
      echo "##vso[task.setvariable variable=AZURE_EFS_CONTAINER_REGISTRY_NAME;]$EFS_CONTAINER_REGISTRY_NAME"
      echo "##vso[task.setvariable variable=AZURE_EFS_CONTAINER_APPS_ENVIRONMENT_NAME;]$EFS_CONTAINER_APPS_ENVIRONMENT_NAME"
      echo "##vso[task.setvariable variable=AZURE_EFS_APPLICATION_INSIGHTS_NAME;]$EFS_APPLICATION_INSIGHTS_NAME"
      echo "##vso[task.setvariable variable=AZURE_EFS_EVENT_HUB_NAMESPACE_NAME;]$EFS_EVENT_HUB_NAMESPACE_NAME"

      echo "Retained resources found:"
      echo "--------------------------------------------------------------------------------"
      echo $EFS_RETAIN_RESOURCE_GROUP
      echo $EFS_SERVICE_IDENTITY_NAME
      echo $EFS_LOG_ANALYTICS_WORKSPACE_NAME
      echo $EFS_CONTAINER_REGISTRY_NAME
      echo $EFS_CONTAINER_APPS_ENVIRONMENT_NAME
      echo $EFS_APPLICATION_INSIGHTS_NAME
      echo $EFS_EVENT_HUB_NAMESPACE_NAME
      echo "--------------------------------------------------------------------------------"
